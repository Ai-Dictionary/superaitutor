<div class="profile-page">
    <div class="head flx">
        <h4>Account Details <span>for <%= (typeof(user?.id)!='undefined'?(user?.id):'Unknown ID') %></span></h4>
        <div class="flx normal-option">
            <div class="btn btn-outline-process" title="Change my profile information" onclick="toggleUserData();">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil"
                    viewBox="0 0 16 16">
                    <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325" />
                </svg>
                Edit Profile
            </div>
            <div class="btn btn-process">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                    class="bi bi-person-lines-fill" viewBox="0 0 16 16">
                    <path
                        d="M6 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6m-5 6s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zM11 3.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 1-.5-.5m.5 2.5a.5.5 0 0 0 0 1h4a.5.5 0 0 0 0-1zm2 3a.5.5 0 0 0 0 1h2a.5.5 0 0 0 0-1zm0 3a.5.5 0 0 0 0 1h2a.5.5 0 0 0 0-1z" />
                </svg>
                Public Profile
            </div>
        </div>
        <div class="flx save-option">
            <div class="btn btn-outline-secondary save-info" title="Change my profile information" onclick="userProfile.saveChange();" disabled="true">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-floppy" viewBox="0 0 16 16">
                    <path d="M11 2H9v3h2z"/>
                    <path d="M1.5 0h11.586a1.5 1.5 0 0 1 1.06.44l1.415 1.414A1.5 1.5 0 0 1 16 2.914V14.5a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 14.5v-13A1.5 1.5 0 0 1 1.5 0M1 1.5v13a.5.5 0 0 0 .5.5H2v-4.5A1.5 1.5 0 0 1 3.5 9h9a1.5 1.5 0 0 1 1.5 1.5V15h.5a.5.5 0 0 0 .5-.5V2.914a.5.5 0 0 0-.146-.353l-1.415-1.415A.5.5 0 0 0 13.086 1H13v4.5A1.5 1.5 0 0 1 11.5 7h-7A1.5 1.5 0 0 1 3 5.5V1H1.5a.5.5 0 0 0-.5.5m3 4a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5V1H4zM3 15h10v-4.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5z"/>
                </svg>
                No Change Detect
            </div>
            <div class="btn btn-outline-danger" title="Discard my all changes" onclick="userProfile.cancelChange();" disabled="true">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-circle" viewBox="0 0 16 16">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                    <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                </svg>
                Cancel
            </div>
        </div>
    </div>
    <% 
        function formatDate(dob) {
            if (!dob) return '1947-08-15';
            if (/^\d{4}-\d{2}-\d{2}$/.test(dob)) return dob;
            const [dd, mm, yyyy] = dob.split('-');
            if (!dd || !mm || !yyyy) return '1947-08-15';
            return `${yyyy}-${mm}-${dd}`;
        }
    %>
    <%
        function extractPages(html, user, index) {
            const marker = '\u003Cdiv class="page';
            const chunks = html.split(marker).filter(c => c.trim() !== '');
            if (index >= chunks.length) return '';
            const current = chunks[index];
            let content = marker + current;

            content = content.replace(/<input([^>]*?)id="([^"]+)"([^>]*?)>/gi, (match, beforeId, fieldId, afterId) => {
                let valueRaw = user?.[fieldId] ?? '';
                if(fieldId === 'address'){
                    valueRaw = user?.address?.split(' P.O- ')[0] ?? '';
                }else if(fieldId === 'postoffice'){
                    valueRaw = user?.address?.split(' P.O- ')[1] ?? '';
                }
                if (/value\s*=/.test(match)) return match;
                const isDate = /type\s*=\s*["']date["']/i.test(match);
                const value = isDate ? formatDate(valueRaw) : valueRaw;
                return `<input${beforeId}id="${fieldId}"${afterId.trim()} value="${value}">`;
            });
            content = content.replace(/<select([^>]*?)id="([^"]+)"([^>]*?)>/gi, (match, beforeId, fieldId, afterId) => {
                const value = user?.[fieldId] ?? '';
                if (/data-value\s*=/.test(match)) return match;
                return `<select${beforeId}id="${fieldId}"${afterId.trim()} data-value="${value}">`;
            });

            return content;
        }
        const page1 = extractPages(page, user, 1);
        const page2 = extractPages(page, user, 2);
        const page3 = extractPages(page, user, 3);

    %>
    <div class="body flx">
        <div class="left-component">
            <div class="dp profile-dp" title="My Desktop Picture" <%- `style="background: ${user?.bg || '#eee'};"` %>>
                <%- (typeof(user?.name)!='undefined'?(user?.name?.split(' ').filter(Boolean)[0]?.[0] || '') + (user?.name?.split(' ').filter(Boolean).slice(-1)[0]?.[0] || '0'):'UN') %>
            </div>
            <div class="breaker">Personal Details</div>
            <div class="user-data">
                <%- page1 %> 
            </div>
        </div>
        <div class="right-component">
            <div class="small-component">
                <div class="breaker"><%- type=='student'?'Academic':(type=='teacher'?'Educational':(type=='admin'?'Role':'Unknown')) %> Details</div>
                <div class="user-data">
                    <%- page2 %> 
                </div>
            </div>
            <div class="small-component">
                <div class="breaker"><%- type=='student'?'Career':(type=='teacher'?'Experience':(type=='admin'?'Reference':'Unknown')) %>  Details</div>
                <div class="user-data">
                    <%- page3 %> 
                </div>
            </div>
            <div class="small-component">
                <div class="breaker">Security Details</div>
                <div class="security-mark">
                    <div class="form-group flx">
                        <input type="password" class="form-control" id="password" placeholder="Enter your current password"
                            required />
                        <div class="btn btn-outline-process" onclick="userProfile.unlock();">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-unlock" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M12 0a4 4 0 0 1 4 4v2.5h-1V4a3 3 0 1 0-6 0v2h.5A2.5 2.5 0 0 1 12 8.5v5A2.5 2.5 0 0 1 9.5 16h-7A2.5 2.5 0 0 1 0 13.5v-5A2.5 2.5 0 0 1 2.5 6H8V4a4 4 0 0 1 4-4M2.5 7A1.5 1.5 0 0 0 1 8.5v5A1.5 1.5 0 0 0 2.5 15h7a1.5 1.5 0 0 0 1.5-1.5v-5A1.5 1.5 0 0 0 9.5 7z"/>
                            </svg>
                            Unlock
                        </div>
                    </div>
                    <small class="form-text text-muted">Please verify your current password to access and manage your security details, including viewing or updating your password and other safty credentials.</small>
                </div>
                <div class="user-data hidden">
                    <div class="form-group flx">
                        <label for="favouriteColor">Favourite color</label>
                        <input type="color" class="form-control" id="fav_color" value="#0c8ff9"
                            placeholder="e.g., Blue, Red, #000" required />

                    </div>
                    <div class="form-group flx">
                        <label for="favouriteBook">Favourite book</label>
                        <input type="text" class="form-control" id="fav_book" maxlength="30"
                            placeholder="e.g., The Alchemist, Harry Potter" required />
                    </div>
                    <div class="form-group flx">
                        <label for="createPassword">Password</label>
                        <input type="password" class="form-control" id="pass" placeholder="Enter a secure password"
                            required />
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>